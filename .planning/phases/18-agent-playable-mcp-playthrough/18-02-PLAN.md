# Phase 18-02 Plan

## Objective

Close Phase 18 by delivering:

1. A dense deterministic fixture (>= 75 turns) with broad action-family coverage.
2. Determinism regression checks for repeated runs.
3. Behavioral parity checks between `/play` presenter action surfaces and MCP session actions.

## Tasks

1. Extend replay harness to support deterministic fixture setup state (entity pruning, player preconditions, colocated enemy setup).
2. Add canonical dense fixture:
- `packages/engine/test-fixtures/canonical-dense-trace-v1.json`
- 75 actions minimum
- canonical seed
- expected snapshot hash lock
3. Extend replay smoke script to validate:
- baseline fixture hash lock
- dense fixture hash lock
- repeated rerun determinism
- dense fixture quality checks (action-family coverage, cutscene/warning presence)
4. Add MCP parity smoke script:
- compare presenter player-action surface vs MCP `list_actions`
- replay dense fixture through MCP session dispatch path
- assert MCP snapshot hash equals direct replay snapshot hash
5. Wire parity checks into CI workflows (`docs-browser-game.yml`, `engine-package-release.yml`).
6. Add docs-site package-consumer unit coverage for dense fixture replay behavior.

## Verification

- `pnpm --dir packages/engine run typecheck`
- `pnpm --dir packages/engine run build`
- `pnpm --dir packages/engine run test:replay-smoke`
- `pnpm --dir packages/engine-mcp run typecheck`
- `pnpm --dir packages/engine-mcp run test:parity-smoke`
- `pnpm --dir docs-site run test:unit`
